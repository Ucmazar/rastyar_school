{% extends "base.html" %}
{% block title %}ูุณุช ฺฉูุงุณโูุง{% endblock %}

{% block content %}
<div class="app-content">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5">๐ซ ูุณุช ฺฉูุงุณโูุง</h2>
      <a href="{% url 'create_class' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-circle"></i> ุงุฌุงุฏ ฺฉูุงุณ ุฌุฏุฏ
      </a>
    </div>

    <div class="">
      <table class="table table-sm table-striped table-hover table-bordered align-middle small">
        <thead class="table-dark">
          <tr>
            <th>ุดูุงุฑู</th>
            <th>ูุงู ฺฉูุงุณ</th>
            <th>ุฏุฑุฌู</th>
            <th>ูุนูู</th>
            <th>ุชุนุฏุงุฏ ุดุงฺฏุฑุฏุงู</th>
            <th>ฺฏุฑูู ูุถุงูู</th>
            <th>ุนููุงุช</th>
          </tr>
        </thead>
        <tbody>
          {% for class in classes %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ class.name }}</td>
            <td>{{ class.grade }}</td>
            <td>
              {% if class.teacher and class.teacher.user %}
              {{ class.teacher.user.full_name_display }}
              {% else %}
              โ
              {% endif %}
            </td>

            <td>{{ class.students.count }}</td>
            <td>
              {% if class.subject_group %}
              {{ class.subject_group.name }}
              {% else %}
              โ
              {% endif %}
            </td>
            
            <td>
              <div class="d-flex align-items-center">
                <!-- ุฏฺฉููโูุง ุงุตู ฺฉู ููู ูุณุชูุฏ -->
                <a href="{% url 'update_class' class.pk %}" class="btn btn-sm btn-warning me-1" title="ูุฑุงุด">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <a href="{% url 'delete_class' class.pk %}" class="btn btn-sm btn-danger me-1" title="ุญุฐู">
                  <i class="bi bi-trash"></i>
                </a>
            
                <!-- ุฏฺฉูู ุณู ููุทู ุจุฑุง ุจูู ุนููุงุช -->
                <div class="dropdown">
                  <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdownMenuButton{{ class.pk }}" data-bs-toggle="dropdown" aria-expanded="false">
                   ุนููุงุช ุจุดุชุฑ  
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ class.pk }}">
                    <li>
                      <a class="dropdown-item" href="{% url 'export_class_shoqaA4' class.pk %}">
                        <i class="bi bi-file-earmark-excel"></i> ุงฺฉุณู ุดูู
                      </a>
                    </li>
                    <li>
                      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#examModalShoqa{{ class.pk }}">
                        <i class="bi bi-printer"></i> ูพุฑูุช ุดูู
                      </button>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'export_class_zawabetA4' class.pk %}">
                        <i class="bi bi-file-earmark-excel"></i> ุงฺฉุณู ุถูุงุจุท
                      </a>
                    </li>
                    <li>
                      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#examModalZawabet{{ class.pk }}">
                        <i class="bi bi-printer"></i> ูพุฑูุช ุถูุงุจุท
                      </button>
                    </li>
                    <li>
                      <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#gradeAttendanceModal{{ class.pk }}">
                        <i class="bi bi-journal-check"></i> ุซุจุช ููุฑู
                      </button>
                    </li>
                    <li>
                      <button class="dropdown-item" disabled>
                        <i class="bi bi-clock"></i> ฺฉุงุฑูุงูู
                      </button>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'download_class_qr' class.id %}">
                        <i class="bi bi-qr-code"></i> QR
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </td>
            
<!--ูุฏุงู ุซุจุช ููุฑู  -->
<div class="modal fade" id="gradeAttendanceModal{{ class.pk }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ุงูุชุฎุงุจ ุงูุชุญุงู - {{ class.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <select id="examSelect{{ class.pk }}" class="form-select">
          <option value="">-- ุงูุชุฎุงุจ ุงูุชุญุงู --</option>
          {% for exam in exams %}
            <option value="{{ exam.id }}">{{ exam.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="goToGradeEntry({{ class.pk }})">
          ููุงุด ุฌุฏูู ููุฑู
        </button>
      </div>
    </div>
  </div>
</div>


            

            <!-- ูุฏุงู ุดูู -->
            <div class="modal fade" id="examModalShoqa{{ class.pk }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">ุงูุชุฎุงุจ ุงูุชุญุงู ุจุฑุง ุดูู ุตูู : {{ class.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <form id="printForm{{ class.pk }}">
                      {% csrf_token %}
                      <label for="exam_id{{ class.pk }}">ุงูุชุฎุงุจ ุงูุชุญุงู:</label>
                      <select name="exam_id" id="exam_id{{ class.pk }}" required class="form-select">
                        <option value="">-- ุงูุชุฎุงุจ ุงูุชุญุงู --</option>
                        {% for exam in exams %}
                        <option value="{{ exam.id }}">{{ exam.name }}</option>
                        {% endfor %}
                      </select>
                      <!-- ุฏฺฉูู ูพุฑูุช ุฏุงุฎู ูุฏุงู -->
                      <button type="button" class="btn btn-primary mt-2" data-class-id="{{ class.pk }}"
                        onclick="printClassShoqaFromButton(this)">
                        ูพุฑูุช ุดูู
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>


            <!-- ูุฏุงู ุถูุงุจุท -->
            <div class="modal fade" id="examModalZawabet{{ class.pk }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">ุงูุชุฎุงุจ ุงูุชุญุงู ุจุฑุง ุถูุงุจุท ุตูู: {{ class.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <form id="printForm{{ class.pk }}">
                      {% csrf_token %}
                      <label for="exam_id{{ class.pk }}">ุงูุชุฎุงุจ ุงูุชุญุงู:</label>
                      <!-- ูุฏุงู ุถูุงุจุท -->
                      <select id="exam_id_zawabet{{ class.pk }}" class="form-select">
                        <option value="">-- ุงูุชุฎุงุจ ุงูุชุญุงู --</option>
                        {% for exam in exams %}
                        <option value="{{ exam.id }}">{{ exam.name }}</option>
                        {% endfor %}
                      </select>

                      <!-- ุฏฺฉูู ูพุฑูุช ุฏุงุฎู ูุฏุงู -->
                      <button type="button" class="btn btn-primary mt-2" data-class-id="{{ class.pk }}"
                        onclick="printClassZawabetFromButton(this)">
                        ูพุฑูุช ุถูุงุจุท
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center">ูฺ ฺฉูุงุณ ุซุจุช ูุดุฏู ุงุณุช.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <a href="{% url 'home' %}" class="btn btn-secondary btn-sm mt-3">
      <i class="bi bi-arrow-left-circle"></i> ุจุงุฒฺฏุดุช ุจู ุฏุงุดุจูุฑุฏ
    </a>
  </div>
</div>



<script>
  

  function goToGradeEntry(classId) {
    const select = document.getElementById('examSelect' + classId);
    if (!select) {
        alert("ุฎุทุง: ุงูุชุญุงู ูพุฏุง ูุดุฏ.");
        return;
    }

    const examId = select.value;
    if (!examId) {
        alert("ูุทูุง ุงูุชุญุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.");
        return;
    }

    // ุฑุฏุงุฑฺฉุช ุจุง query string
    window.location.href = `/grades/entry/?class=${classId}&exam_type=${examId}`;
}


  // ุชุงุจุน ุจุฑุง bind ฺฉุฑุฏู eventูุง input ุจุนุฏ ุงุฒ ุจุงุฑฺฏุฐุงุฑ ุฌุฏูู
  function bindGradeAttendanceEvents() {
    // ุชุบุฑ ููุฑู
    $('.grade-input').off('change').on('change', function () {
      const $this = $(this);
      const studentId = $this.data('student');
      const subjectId = $this.data('subject');
      const score = $this.val();
      send_grade_ajax(studentId, subjectId, score, $this);
    });

    // ุชุบุฑ ุญุถูุฑ ู ุบุงุจ
    $('.attendance-input').off('change').on('change', function () {
      const $this = $(this);
      const studentId = $this.data('student');

      const present = $('input.attendance-input[data-student="' + studentId + '"][data-type="present"]').val() || 0;
      const absent = $('input.attendance-input[data-student="' + studentId + '"][data-type="absent"]').val() || 0;
      const sick = $('input.attendance-input[data-student="' + studentId + '"][data-type="sick"]').val() || 0;
      const leave = $('input.attendance-input[data-student="' + studentId + '"][data-type="leave"]').val() || 0;

      send_attendance_ajax(studentId, present, absent, sick, leave, $this);
    });
  }

  function printClassZawabetFromButton(btn) {

    const classId = btn.dataset.classId;
    const select = document.getElementById('exam_id_zawabet' + classId);
    if (!select) {
      alert("ุฎุทุง: ุงูุชุญุงู ูพุฏุง ูุดุฏ.");
      return;
    }


    console.log("ClassId:", classId);
    console.log("Select element:", select);
    console.log("Exam value:", select ? select.value : "Select not found");
    const examId = select.value;

    if (!examId) {
      alert("ูุทูุงู ฺฉ ุงูุชุญุงู ุงูุชุฎุงุจ ฺฉูุฏ.");
      return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'class_print_zawabet' 0 %}".replace('/0/', '/' + classId + '/'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({ 'exam_id': examId })
    })
      .then(r => r.text())
      .then(html => {
        // ุจุงุฒ ฺฉุฑุฏู ุตูุญู ูพุฑูุช
        const w = window.open('', '_blank');
        w.document.write(html);
        w.document.close();
        w.focus();
        w.print();
        w.close();

        // ุจุณุชู ูุฏุงู ูุฑุจูุทู
        const modalEl = document.getElementById('examModal' + classId);
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
          modalInstance.hide();
        }
      })
      .catch(err => console.error(err));
  }


  function printClassShoqaFromButton(btn) {
    const classId = btn.dataset.classId;
    const select = document.getElementById('exam_id' + classId);
    if (!select) {
      alert("ุฎุทุง: ุงูุชุญุงู ูพุฏุง ูุดุฏ.");
      return;
    }

    const examId = select.value;



    if (!examId) {
      alert("ูุทูุงู ฺฉ ุงูุชุญุงู ุงูุชุฎุงุจ ฺฉูุฏ.");
      return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'class_print_shoqa' 0 %}".replace('/0/', '/' + classId + '/'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({ 'exam_id': examId })
    })
      .then(r => r.text())
      .then(html => {
        // ุจุงุฒ ฺฉุฑุฏู ุตูุญู ูพุฑูุช
        const w = window.open('', '_blank');
        w.document.write(html);
        w.document.close();
        w.focus();
        w.print();
        w.close();

        // ุจุณุชู ูุฏุงู ูุฑุจูุทู
        const modalEl = document.getElementById('examModal' + classId);
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
          modalInstance.hide();
        }
      })
      .catch(err => console.error(err));
  }


</script>

{% endblock %}