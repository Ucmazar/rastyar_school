{% extends "base.html" %}
{% load jformat %}
{% block title %}لیست امتحانات{% endblock %}

{% block content %}
<div class="app-content">
  <div class="container-fluid">

    <!-- عنوان و دکمه اضافه کردن -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5">📋 لیست امتحانات</h2>
      <a href="{% url 'examtype_create' %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-circle"></i> اضافه کردن امتحان
      </a>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-striped table-hover table-bordered align-middle small">
        <thead class="table-dark">
          <tr>
            <th>شماره</th>
            <th>نام امتحان</th>
            <th>توضیحات</th>
            <th>سال تحصیلی</th>
            <th>ایام آموزشی</th>
            <th>ایجاد شده توسط</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for exam in exams %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ exam.name }}</td>
            <td>{{ exam.description|default:"-" }}</td>
            <td>{{ exam.academic_year }}</td>
            <td>{{ exam.academic_year_days }}</td>
            <td>
              {% if exam.created_by %}
                {{ exam.created_by.get_full_name|default:exam.created_by.username }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if exam.created_by == request.user %}
              <a href="{% url 'examtype_update' exam.pk %}" class="btn btn-sm btn-warning mb-1">
                <i class="bi bi-pencil-square"></i> ویرایش
              </a>
              <a href="{% url 'examtype_delete' exam.pk %}" class="btn btn-sm btn-danger mb-1">
                <i class="bi bi-trash"></i> حذف
              </a>
              {% else %}
                <span class="text-muted small">🔒 قابل ویرایش نیست</span>
              {% endif %}

              <!-- دکمه مشاهده شاگردان ثبت شده در امتحان -->
              <button type="button" class="btn btn-sm btn-info mb-1" data-bs-toggle="modal" data-bs-target="#examStudentsModal{{ exam.id }}">
                <i class="bi bi-people-fill"></i> شاگردان
              </button>

              <!-- Modal نمایش شاگردان -->
              <div class="modal fade" id="examStudentsModal{{ exam.id }}" tabindex="-1" aria-labelledby="examStudentsModalLabel{{ exam.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="examStudentsModalLabel{{ exam.id }}">شاگردان امتحان {{ exam.name }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      {% if exam.students.exists %}
                        <ul class="list-group list-group-flush">
                          {% for student in exam.students.all %}
                            <li class="list-group-item">
                              {{ student.user.first_name }} {{ student.user.last_name }} - شماره: {{ student.student_number }}
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <p class="text-muted">هیچ شاگردی برای این امتحان ثبت نشده است.</p>
                      {% endif %}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>
                  </div>
                </div>
              </div>

            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-3">هیچ امتحانی ثبت نشده است.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- دکمه بازگشت به داشبورد -->
    <div class="mt-3">
      <a href="{% url 'home' %}" class="btn btn-secondary btn-sm">
        <i class="bi bi-arrow-left-circle"></i> بازگشت به داشبورد
      </a>
    </div>

  </div>
</div>
{% endblock %}
