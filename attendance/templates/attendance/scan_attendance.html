{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>Ø«Ø¨Øª Ø­Ø¶ÙˆØ± Ø¨Ø§ QR</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
<h2>Ø§Ø³Ú©Ù† QR Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø­Ø¶ÙˆØ±</h2>

<div id="reader" style="width:100%; max-width:500px; margin-bottom:20px;"></div>
<p id="result">Ù†ØªÛŒØ¬Ù‡ Ø§Ø³Ú©Ù†: </p>


<a href="{% url 'home' %}">Back to home</a>


<div id="attendance-log" class="p-3 border rounded bg-light mt-3" style="max-height:250px; overflow-y:auto;">
    <h4>ðŸ“‹ Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ± Ø§Ù…Ø±ÙˆØ²</h4>
    <ul id="attendance-list" class="list-group"></ul>
</div>

<script>

    function refreshAttendanceList(){
        fetch("/attendance/latest/")
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById("attendance-list");
            list.innerHTML = "";
            data.records.forEach(r => {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.textContent = `${r.student} | ØµÙ†Ù: ${r.class} | Ø²Ù…Ø§Ù†: ${r.time}`;
                list.appendChild(li);
            });
        });
    }
    
    // Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øª Ù…ÙˆÙÙ‚
    function sendToken(token){
        fetch("/attendance/mark-qr/", {
            method: "POST",
            headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
            body: JSON.stringify({token: token})
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                logStep("âœ… Ø­Ø¶ÙˆØ± Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ: " + data.student_name);
                refreshAttendanceList(); // ðŸ”„ Ù„ÛŒØ³Øª Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆØ¯
            } else {
                alert("âŒ " + data.error);
            }
        });
    }
    
    // Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡ Ø§ØªÙˆÙ…Ø§Øª Ø±ÙØ±Ø´ Ø´ÙˆØ¯
    setInterval(refreshAttendanceList, 10000);
    
    // Ø¨Ø§Ø± Ø§ÙˆÙ„
    refreshAttendanceList();

    
    
function logStep(step){
    console.log(step);
    document.getElementById('result').innerText = step;
}

// Ø«Ø¨Øª Ø­Ø¶ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø±
function sendAttendance(token){
    logStep(`Ù…Ø±Ø­Ù„Ù‡ 1: Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù† Ø¨Ù‡ Ø³Ø±ÙˆØ± -> ${token}`);

    fetch("{% url 'mark_attendance_qr' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ attendance_token: token })
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === "success"){
            logStep("âœ… Ø­Ø¶ÙˆØ± Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ: " + data.student);
        } else if(data.status === "exists"){
            logStep("âš ï¸ Ø­Ø¶ÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ: " + data.student);
        } else if(data.error){
            logStep("âŒ Ø®Ø·Ø§: " + data.error);
        } else {
            logStep("âŒ Ù¾Ø§Ø³Ø® ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±");
        }
    })
    .catch(err => {
        console.error(err);
        logStep("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ø³Ø±ÙˆØ±!");
    });
}

// Ø§Ø³Ú©Ù† QR Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ†
function onScanSuccess(decodedText, decodedResult) {
    const token = decodedText.trim();
    if(!token){
        alert("QR Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!");
        return;
    }

    logStep("Ù…Ø±Ø­Ù„Ù‡ 0: QR Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯ -> " + token);

    // Ø«Ø¨Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø­Ø¶ÙˆØ±
    sendAttendance(token);
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ù†Ú¯Ø±
var html5QrcodeScanner = new Html5QrcodeScanner(
    "reader", { fps: 10, qrbox: 300 }, false);
html5QrcodeScanner.render(onScanSuccess);
</script>

</body>
</html>
